const baseUrl="https://192.168.75.115/api/v3/";function show(e){const t=document.querySelector(".active");t.classList.remove("active"),t.classList.add("inactive");const o=document.querySelector(e.split("/")[0]);o.classList.remove("inactive"),o.classList.add("active")}function displayRequestResult(e,t,o="alert-info"){const s=document.getElementById(e);s.innerText=t,s.classList.add(o),setTimeout((()=>{s.classList.remove(o),s.innerText=""}),1e4)}function renderTemplate(e,t,o){const s=document.getElementById(e).innerHTML,n=Mustache.render(s,t);document.getElementById(o).innerHTML=n}function renderTemplateTable(e,t,o){const s=document.getElementById(e).innerHTML,n=Mustache.render(s,t);document.getElementById(o).innerHTML+=n}function displayConnected(e){const t=document.getElementsByClassName("requiresConnection"),o=e?"visible":"collapse";for(const e of t)e.style.visibility=o}function displayDisconnected(e){const t=document.getElementsByClassName("requiresDisconnection"),o=e?"visible":"collapse";for(const e of t)e.style.visibility=o}function getNumberOfUsers(){const e=new Headers;e.append("Accept","application/json");fetch(baseUrl+"users",{method:"GET",headers:e,mode:"cors"}).then((e=>{if(e.ok&&e.headers.get("Content-Type").includes("application/json"))return e.json();throw new Error("Response is error ("+e.status+") or does not contain JSON ("+e.headers.get("Content-Type")+").")})).then((e=>{if(!Array.isArray(e))throw new Error(e+" is not an array.");renderTemplate("userCountTemplate",{nbUsers:e.length},"nbUsers")})).catch((e=>{console.error("In getNumberOfUsers: "+e)}))}function getAllTodos(){const e=new Headers;e.append("Authorization",sessionStorage.getItem("accessToken")),e.append("Accept","application/json");fetch(baseUrl+"todos",{method:"GET",headers:e,mode:"cors"}).then((e=>{if(200===e.status)return e.json();throw new Error("Bad response code ("+e.status+").")})).then((e=>{renderTemplate("todosCountTemplate",{nbTodos:e.length},"nbTodos")})).catch((e=>{console.error("Erreur dans getAllTodos: "+e)}))}function updateNumbersTodosUsers(){getAllTodos(),getNumberOfUsers()}function setInfos(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Accept","application/json");fetch(baseUrl+"users/"+e+"/name",{method:"GET",headers:t,mode:"cors"}).then((e=>{if(200===e.status)return e.json()})).then((e=>{renderTemplate("userNameTemplate",{nom_update_input:e.name},"nom_update_input")})).catch((e=>{console.error("In setInfos: "+e)}))}function setTodos(){const e=new Headers;e.append("Authorization",sessionStorage.getItem("accessToken")),e.append("Accept","application/json");fetch(baseUrl+"todos",{method:"GET",headers:e,mode:"cors"}).then((e=>{200===e.status&&e.json().then((e=>{document.getElementById("tablebody").innerHTML="",e.forEach((e=>insertTodo(e)))}))})).catch((e=>{console.error("In setInfos: "+e)}))}function updateTableRow(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Accept","application/json");fetch(baseUrl+"todos/"+e,{method:"GET",headers:t,mode:"cors"}).then((e=>{if(200===e.status)return e.json();throw new Error("Bad response code ("+e.status+").")})).then((t=>{const o=document.getElementById("todoRow_"+e);if(o){const s={completed:t.completed,todoId:e,title:t.title,assignee:null==t.assignee?"Personne":extractUsername(t.assignee),Isassignee:null!=t.assignee,btn_clickable:t.completed?"disabled":"enabled"},n=Mustache.render(document.getElementById("tableTemplate").innerHTML,s);o.outerHTML=n}})).catch((e=>{console.error("Erreur dans updateTableRow: "+e)}))}function extractUsername(e){return e.split("/")[1]}function extractTodoId(e){return e.split("/")[1]}function insertTodo(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Accept","application/json");fetch(baseUrl+"todos/"+e,{method:"GET",headers:t,mode:"cors"}).then((e=>{if(200===e.status)return e.json();throw new Error("Bad response code ("+e.status+").")})).then((t=>{renderTemplateTable("tableTemplate",{completed:t.completed,todoId:e,title:t.title,assignee:null==t.assignee?"Personne":extractUsername(t.assignee),Isassignee:null!=t.assignee,btn_clickable:t.completed?"disabled":"enabled"},"tablebody")})).catch((e=>{console.error("Erreur dans insertTodo: "+e)}))}function assignerTodo(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Content-Type","application/json");const o={assignee:sessionStorage.getItem("login")},s={method:"PUT",headers:t,body:JSON.stringify(o),mode:"cors"};fetch(baseUrl+"todos/"+e,s).then((t=>{if(204!==t.status)throw new Error("Bad response code ("+t.status+").");updateTableRow(e),displayRequestResult("requestResult-todos","Assignation du todo réussie","alert-success")}))}function retirerTodo(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Content-Type","application/json");const o={method:"PUT",headers:t,body:JSON.stringify({assignee:"null"}),mode:"cors"};fetch(baseUrl+"todos/"+e,o).then((e=>{if(204!==e.status)throw new Error("Bad response code ("+e.status+").");displayRequestResult("requestResult-todos","Retrait du todo réussi","alert-success")})).then((()=>{updateTableRow(e)}))}function supprimerTodo(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken"));fetch(baseUrl+"todos/"+e,{method:"DELETE",headers:t,mode:"cors"}).then((t=>{if(204!==t.status)throw new Error("Erreur lors de la suppression du todo (Code: "+t.status+").");{const t=document.getElementById("todoRow_"+e);t&&t.remove(),displayRequestResult("requestResult-todos","Suppression du todo réussie","alert-success")}})).catch((e=>{console.error("Erreur lors de la suppression du todo: "+e)}))}function deleteAllTodos(){const e=new Headers;e.append("Authorization",sessionStorage.getItem("accessToken")),e.append("Accept","application/json");fetch(baseUrl+"todos",{method:"GET",headers:e,mode:"cors"}).then((e=>{200===e.status&&e.json().then((e=>{e.forEach((e=>supprimerTodo(e)))}))})).catch((e=>{console.error("In setInfos: "+e)}))}function completerTodo(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Content-Type","application/json");const o={hash:e},s={method:"POST",headers:t,body:JSON.stringify(o),mode:"cors"};fetch(baseUrl+"todos/toggleStatus",s).then((t=>{if(204!==t.status)throw new Error("Erreur lors de la mise à jour du todo (Code: "+t.status+").");updateTableRow(e),displayRequestResult("requestResult-todos","Mise à jour du todo réussie","alert-success")})).catch((e=>{console.error("Erreur lors de la mise à jour du todo: "+e)}))}function majNom(){const e=document.getElementById("nom_update_input").innerHTML.trim(),t=document.getElementById("login").innerHTML.trim(),o=new Headers;o.append("Authorization",sessionStorage.getItem("accessToken")),o.append("Content-Type","application/json");const s={name:e},n={method:"PUT",headers:o,body:JSON.stringify(s),mode:"cors"};fetch(baseUrl+"users/"+t,n).then((e=>{if(204!==e.status)throw new Error("Bad response code ("+e.status+").");location.hash="#monCompte",setInfos(t),displayRequestResult("requestResult-general","Modification de nom réussie","alert-success")}))}function majMdp(){const e=document.getElementById("password_update_input").value,t=document.getElementById("login").innerHTML.trim(),o=new Headers;o.append("Authorization",sessionStorage.getItem("accessToken")),o.append("Content-Type","application/json");const s={password:e},n={method:"PUT",headers:o,body:JSON.stringify(s),mode:"cors"};fetch(baseUrl+"users/"+t,n).then((e=>{if(204!==e.status)throw new Error("Bad response code ("+e.status+").");location.hash="#monCompte",displayRequestResult("requestResult-general","Modification de mot de passe réussie","alert-success")}))}function creerTodo(){const e=document.getElementById("text").value,t=document.getElementById("login").innerHTML.trim(),o=new Headers;o.append("Authorization",sessionStorage.getItem("accessToken")),o.append("Content-Type","application/json");const s={title:e,creator:t},n={method:"POST",headers:o,body:JSON.stringify(s),mode:"cors"};fetch(baseUrl+"todos/",n).then((e=>{if(201!==e.status)throw new Error("Bad response code ("+e.status+").");getAllTodos(),setTodos(),displayRequestResult("requestResult-todos","Création du todo réussie","alert-success")})).catch((e=>{console.error("In creerTodo: "+e)}))}function getTodoById(e){const t=new Headers;t.append("Authorization","Bearer "+sessionStorage.getItem("accessToken")),t.append("Accept","application/json");fetch(baseUrl+"/todos/"+e,{method:"GET",headers:t}).then((e=>{if(200===e.status)return e.json();throw 400===e.status?new Error("Id du todo syntaxiquement incorrect (non entier)"):401===e.status?new Error("Utilisateur non authentifié"):404===e.status?new Error("Todo non trouvé"):new Error("Erreur non spécifiée")})).then((e=>(console.log("Todo récupéré: ",e),e))).catch((e=>{console.error(e)}))}function connect(){const e=new Headers;e.append("Content-Type","application/json");const t={login:document.getElementById("login_input").value,password:document.getElementById("password_input").value},o={method:"POST",headers:e,body:JSON.stringify(t),mode:"cors"};fetch(baseUrl+"users/login",o).then((e=>{if(204!==e.status)throw displayRequestResult("requestResult-general","Connexion refusée ou impossible","alert-danger"),new Error("Bad response code ("+e.status+").");{location.hash="#index";const o=e.headers.get("Authorization");sessionStorage.setItem("accessToken",o),sessionStorage.setItem("login",t.login),renderTemplate("userLoginTemplate",{login:t.login},"login"),renderTemplate("usernameBonjourTemplate",{username:t.login},"username"),displayConnected(!0),displayDisconnected(!1),displayRequestResult("requestResult-general","Connexion réussie","alert-success"),setInfos(t.login)}})).catch((e=>{console.error("In connect: "+e)}))}function deco(){const e=new Headers;e.append("Authorization",sessionStorage.getItem("accessToken")),e.append("Content-Type","application/json");const t={method:"POST",headers:e,mode:"cors",body:JSON.stringify({})};fetch(baseUrl+"users/logout",t).then((e=>{if(204!==e.status)throw displayRequestResult("requestResult-general","Déconnexion impossible","alert-danger"),new Error("Bad response code ("+e.status+").");sessionStorage.removeItem("accessToken"),location.hash="#index",displayConnected(!1),displayDisconnected(!0),displayRequestResult("requestResult-general","Déconnexion réussie","alert-success")})).catch((e=>{console.error("In login: "+e)}))}function getUserAssignedTodos(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Accept","application/json");return fetch(baseUrl+"users/"+e+"/assignedTodos",{method:"GET",headers:t,mode:"cors"}).then((e=>{if(!e.ok)throw new Error("Erreur lors de la récupération des todos assignés (Code: "+e.status+")");return e.json()})).then((e=>(console.log("Récupération des todos assignés réussie"),e.assignedTodos))).catch((e=>{throw console.error("Erreur dans getUserAssignedTodos: "+e),e}))}function getTodoTitle(e){const t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Content-Type","application/json");return fetch(baseUrl+"todos/"+e+"/title",{method:"GET",headers:t,mode:"cors"}).then((e=>{if(200===e.status)return e.json();throw new Error("Bad response code ("+e.status+").")})).then((e=>e.title)).catch((e=>{throw console.error("In getTodoTitle: "+e),e}))}function setTodosMonCompte(){const e=sessionStorage.getItem("login"),t=new Headers;t.append("Authorization",sessionStorage.getItem("accessToken")),t.append("Accept","application/json"),fetch(baseUrl+"users/"+e+"/assignedTodos",{method:"GET",headers:t,mode:"cors"}).then((e=>{if(!e.ok)throw new Error("Erreur lors de la récupération des todos assignés (Code: "+e.status+")");return e.json()})).then((e=>{const o=e.assignedTodos.map((e=>{const o=extractTodoId(e);return fetch(baseUrl+"todos/"+o+"/title",{method:"GET",headers:t,mode:"cors"}).then((e=>{if(200===e.status)return e.json();throw new Error("Bad response code ("+e.status+") for todo ID: "+o)})).then((e=>e.title)).catch((e=>console.error("Erreur dans la récupération du titre: "+e)))}));return Promise.all(o)})).then((e=>{document.getElementById("TodosMonCompte").innerHTML="",e.forEach((e=>{if(e){renderTemplateTable("todoMonCompteTemplate",{title:e},"TodosMonCompte")}}))})).catch((e=>{console.error("Erreur dans setTodosMonCompte: "+e)}))}function getUsername(e,t){if("Personne"!==e){const o=new Headers;o.append("Authorization",sessionStorage.getItem("accessToken")),o.append("Accept","application/json");fetch(baseUrl+"users/"+e+"/name",{method:"GET",headers:o,mode:"cors"}).then((e=>{if(200===e.status)return e.json();throw new Error("Erreur lors de la récupération du nom d'utilisateur")})).then((e=>{renderTemplate("popupTemplate",{username:e.name},"popup"),afficherPopup(t)})).catch((e=>{console.error("Erreur dans getUsername: "+e)}))}}function afficherPopup(e){var t=document.getElementById("popup");t.style.left=e.clientX+5+"px",t.style.top=e.clientY+5+"px",t.style.display="block"}function masquerPopup(){document.getElementById("popup").style.display="none"}function editTitle(e,t){if(!e.querySelector("input")){var o=e.innerHTML,s=document.createElement("input");s.type="text",s.value=o,s.size=Math.max(o.length/2,5),s.onblur=function(){if(this.value!==o){e.innerHTML=this.value;const o=new Headers;o.append("Authorization",sessionStorage.getItem("accessToken")),o.append("Content-Type","application/json");const s={title:this.value},n={method:"PUT",headers:o,body:JSON.stringify(s),mode:"cors"};fetch(baseUrl+"todos/"+t,n).then((e=>{if(204!==e.status)throw new Error("Bad response code ("+e.status+").");updateTableRow(t),displayRequestResult("requestResult-todos","Mise à jour du titre réussie","alert-success")})).catch((e=>{console.error("Erreur dans editTitle: "+e)}))}else e.innerHTML=o},e.innerHTML="",e.appendChild(s),s.focus()}}function trierTableauTodo(){var e,t,o,s,n,r,a;for(e=document.getElementById("tablebody"),o=!0;o;){for(o=!1,t=e.rows,s=0;s<t.length-1;s++)if(a=!1,n=t[s].getElementsByTagName("TD")[1],r=t[s+1].getElementsByTagName("TD")[1],n.innerHTML.toLowerCase()>r.innerHTML.toLowerCase()){a=!0;break}a&&(t[s].parentNode.insertBefore(t[s+1],t[s]),o=!0)}}function trierTableauParAssignee(){var e,t,o,s,n,r,a;for(trierTableauTodo(),e=document.getElementById("tablebody"),o=!0;o;){for(o=!1,t=e.rows,s=0;s<t.length-1;s++)if(a=!1,n=t[s].getElementsByTagName("TD")[3],r=t[s+1].getElementsByTagName("TD")[3],n.innerHTML.toLowerCase()<r.innerHTML.toLowerCase()){a=!0;break}a&&(t[s].parentNode.insertBefore(t[s+1],t[s]),o=!0)}}window.addEventListener("hashchange",(()=>{switch(show(window.location.hash),location.hash){case"#monCompte":setTodosMonCompte();break;case"#todoList":setTodos()}})),setInterval(updateNumbersTodosUsers,5e3),setInterval(setTodos,5e3);